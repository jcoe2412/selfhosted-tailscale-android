name: Build Tailscale 1.32.3 with Custom Server

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    
    steps:
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Set up Go 1.19
      uses: actions/setup-go@v5
      with:
        go-version: '1.19.13'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 31
        build-tools: 31.0.0
        ndk: 23.1.7779620
    
    - name: Clone specific working version
      run: |
        # Clone version 1.32.3 which is known to work
        git clone --branch v1.32.3 --depth 1 https://github.com/tailscale/tailscale-android.git
        cd tailscale-android
        
    - name: Simple patch to enable custom server
      working-directory: tailscale-android
      run: |
        # Make the custom server option always visible (not just in debug builds)
        find android/src/main/java -type f \( -name "*.kt" -o -name "*.java" \) -exec sed -i 's/BuildConfig\.DEBUG/true/g' {} \;
        
    - name: Build APK
      working-directory: tailscale-android
      run: |
        cd android
        chmod +x gradlew
        
        # Build debug APK (easier than release, no signing needed)
        ./gradlew assembleDebug --stacktrace
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: tailscale-headscale-ready
        path: tailscale-android/android/build/outputs/apk/debug/*.apk
        retention-days: 90
